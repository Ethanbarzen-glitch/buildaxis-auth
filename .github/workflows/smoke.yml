name: smoke
on: [push, pull_request, workflow_dispatch]

concurrency:
  group: smoke-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Start stack (build + wait for health)
        run: docker compose up -d --build --wait

      - name: Assert healthz for all services
        shell: bash
        run: |
          set -euo pipefail
          curl -sf http://localhost:9001/healthz >/dev/null
          curl -sf http://localhost:9010/healthz >/dev/null
          curl -sf http://localhost:9020/healthz >/dev/null

      - name: Assert JWKS exists (api)
        shell: bash
        run: |
          set -euo pipefail
          curl -sf http://localhost:9001/.well-known/jwks.json | grep -q '"keys"'

      - name: Dump compose logs on failure
        if: failure()
        run: docker compose logs --no-color > compose.logs.txt

      - name: Upload logs (only on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: compose-logs
          path: compose.logs.txt

      - name: Teardown
        if: always()
        run: docker compose down --volumes
